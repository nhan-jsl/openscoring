<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ModelUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Openscoring Service</a> &gt; <a href="index.source.html" class="el_package">org.openscoring.service</a> &gt; <span class="el_source">ModelUtil.java</span></div><h1>ModelUtil.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2015 Villu Ruusmann
 *
 * This file is part of Openscoring
 *
 * Openscoring is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Openscoring is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Openscoring.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.openscoring.service;

import java.util.ArrayList;
import java.util.Collections;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

import com.google.common.base.Function;
import com.google.common.collect.Lists;
import org.dmg.pmml.DataField;
import org.dmg.pmml.DataType;
import org.dmg.pmml.FieldName;
import org.dmg.pmml.Interval;
import org.dmg.pmml.OpType;
import org.dmg.pmml.Value;
import org.jpmml.evaluator.HasGroupFields;
import org.jpmml.evaluator.InputField;
import org.jpmml.evaluator.ModelEvaluator;
import org.jpmml.evaluator.OutputField;
import org.jpmml.evaluator.OutputUtil;
import org.jpmml.evaluator.TargetField;
import org.jpmml.evaluator.TypeUtil;
import org.openscoring.common.Field;

public class ModelUtil {

<span class="nc" id="L46">	private ModelUtil(){</span>
<span class="nc" id="L47">	}</span>

	static
	public Map&lt;String, List&lt;Field&gt;&gt; encodeSchema(ModelEvaluator&lt;?&gt; evaluator){
<span class="fc" id="L51">		Map&lt;String, List&lt;Field&gt;&gt; result = new LinkedHashMap&lt;&gt;();</span>

<span class="fc" id="L53">		List&lt;InputField&gt; activeFields = evaluator.getActiveFields();</span>
<span class="fc" id="L54">		List&lt;InputField&gt; groupFields = Collections.emptyList();</span>

<span class="fc bfc" id="L56" title="All 2 branches covered.">		if(evaluator instanceof HasGroupFields){</span>
<span class="fc" id="L57">			HasGroupFields hasGroupFields = (HasGroupFields)evaluator;</span>

<span class="fc" id="L59">			groupFields = hasGroupFields.getGroupFields();</span>
		}

<span class="fc" id="L62">		result.put(&quot;activeFields&quot;, encodeInputFields(activeFields));</span>
<span class="fc" id="L63">		result.put(&quot;groupFields&quot;, encodeInputFields(groupFields));</span>

<span class="fc" id="L65">		List&lt;TargetField&gt; targetFields = evaluator.getTargetFields();</span>

<span class="fc" id="L67">		result.put(&quot;targetFields&quot;, encodeTargetFields(targetFields));</span>

<span class="fc" id="L69">		List&lt;OutputField&gt; outputFields = evaluator.getOutputFields();</span>

<span class="fc" id="L71">		result.put(&quot;outputFields&quot;, encodeOutputFields(outputFields, evaluator));</span>

<span class="fc" id="L73">		return result;</span>
	}

	static
	private List&lt;Field&gt; encodeInputFields(List&lt;InputField&gt; inputFields){
<span class="fc" id="L78">		Function&lt;InputField, Field&gt; function = new Function&lt;InputField, Field&gt;(){</span>

			@Override
			public Field apply(InputField inputField){
<span class="fc" id="L82">				FieldName name = inputField.getName();</span>

<span class="fc" id="L84">				DataField dataField = (DataField)inputField.getField();</span>

<span class="fc" id="L86">				Field field = new Field(name.getValue());</span>
<span class="fc" id="L87">				field.setName(dataField.getDisplayName());</span>
<span class="fc" id="L88">				field.setDataType(inputField.getDataType());</span>
<span class="fc" id="L89">				field.setOpType(inputField.getOpType());</span>
<span class="fc" id="L90">				field.setValues(encodeValues(dataField));</span>

<span class="fc" id="L92">				return field;</span>
			}
		};

<span class="fc" id="L96">		List&lt;Field&gt; fields = new ArrayList&lt;&gt;(Lists.transform(inputFields, function));</span>

<span class="fc" id="L98">		return fields;</span>
	}

	static
	private List&lt;Field&gt; encodeTargetFields(List&lt;TargetField&gt; targetFields){
<span class="fc" id="L103">		Function&lt;TargetField, Field&gt; function = new Function&lt;TargetField, Field&gt;(){</span>

			@Override
			public Field apply(TargetField targetField){
<span class="fc" id="L107">				FieldName name = targetField.getName();</span>

				// A &quot;phantom&quot; default target field
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">				if(targetField.isSynthetic()){</span>
<span class="nc" id="L111">					name = ModelResource.DEFAULT_NAME;</span>
				}

<span class="fc" id="L114">				DataField dataField = targetField.getDataField();</span>

<span class="fc" id="L116">				Field field = new Field(name.getValue());</span>
<span class="fc" id="L117">				field.setName(dataField.getDisplayName());</span>
<span class="fc" id="L118">				field.setDataType(targetField.getDataType());</span>
<span class="fc" id="L119">				field.setOpType(targetField.getOpType());</span>
<span class="fc" id="L120">				field.setValues(encodeValues(dataField));</span>

<span class="fc" id="L122">				return field;</span>
			}
		};

<span class="fc" id="L126">		List&lt;Field&gt; fields = new ArrayList&lt;&gt;(Lists.transform(targetFields, function));</span>

<span class="fc" id="L128">		return fields;</span>
	}

	static
	private List&lt;Field&gt; encodeOutputFields(List&lt;OutputField&gt; outputFields, final ModelEvaluator&lt;?&gt; evaluator){
<span class="fc" id="L133">		Function&lt;OutputField, Field&gt; function = new Function&lt;OutputField, Field&gt;(){</span>

			@Override
			public Field apply(OutputField outputField){
<span class="fc" id="L137">				FieldName name = outputField.getName();</span>

<span class="fc" id="L139">				org.dmg.pmml.OutputField pmmlOutputField = outputField.getOutputField();</span>

<span class="fc" id="L141">				DataType dataType = outputField.getDataType();</span>
<span class="fc" id="L142">				OpType opType = outputField.getOpType();</span>

<span class="fc bfc" id="L144" title="All 2 branches covered.">				if(dataType == null){</span>

					try {
<span class="nc" id="L147">						dataType = OutputUtil.getDataType(pmmlOutputField, evaluator);</span>
<span class="fc" id="L148">					} catch(Exception e){</span>
						// Ignored
<span class="nc" id="L150">					}</span>
				}

<span class="fc bfc" id="L153" title="All 2 branches covered.">				if(opType == null){</span>

					try {
<span class="nc" id="L156">						opType = TypeUtil.getOpType(dataType);</span>
<span class="fc" id="L157">					} catch(Exception e){</span>
						// Ignored
<span class="nc" id="L159">					}</span>
				}

<span class="fc" id="L162">				Field field = new Field(name.getValue());</span>
<span class="fc" id="L163">				field.setName(pmmlOutputField.getDisplayName());</span>
<span class="fc" id="L164">				field.setDataType(outputField.getDataType());</span>
<span class="fc" id="L165">				field.setOpType(outputField.getOpType());</span>

<span class="fc" id="L167">				return field;</span>
			}
		};

<span class="fc" id="L171">		List&lt;Field&gt; fields = new ArrayList&lt;&gt;(Lists.transform(outputFields, function));</span>

<span class="fc" id="L173">		return fields;</span>
	}

	static
	private List&lt;String&gt; encodeValues(DataField dataField){
<span class="fc" id="L178">		List&lt;String&gt; result = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L180">		List&lt;Interval&gt; intervals = dataField.getIntervals();</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">		for(Interval interval : intervals){</span>
<span class="fc" id="L182">			StringBuilder sb = new StringBuilder();</span>

<span class="fc" id="L184">			Double leftMargin = interval.getLeftMargin();</span>
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">			sb.append(Double.toString(leftMargin != null ? leftMargin : Double.NEGATIVE_INFINITY));</span>

<span class="fc" id="L187">			sb.append(&quot;, &quot;);</span>

<span class="fc" id="L189">			Double rightMargin = interval.getRightMargin();</span>
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">			sb.append(Double.toString(rightMargin != null ? rightMargin : Double.POSITIVE_INFINITY));</span>

<span class="fc" id="L192">			String value = sb.toString();</span>

<span class="fc" id="L194">			Interval.Closure closure = interval.getClosure();</span>
<span class="pc bpc" id="L195" title="4 of 5 branches missed.">			switch(closure){</span>
				case OPEN_OPEN:
<span class="nc" id="L197">					result.add(&quot;(&quot; + value + &quot;)&quot;);</span>
<span class="nc" id="L198">					break;</span>
				case OPEN_CLOSED:
<span class="nc" id="L200">					result.add(&quot;(&quot; + value + &quot;]&quot;);</span>
<span class="nc" id="L201">					break;</span>
				case CLOSED_OPEN:
<span class="nc" id="L203">					result.add(&quot;[&quot; + value + &quot;)&quot;);</span>
<span class="nc" id="L204">					break;</span>
				case CLOSED_CLOSED:
<span class="fc" id="L206">					result.add(&quot;[&quot; + value + &quot;]&quot;);</span>
<span class="fc" id="L207">					break;</span>
				default:
					break;
			}
<span class="fc" id="L211">		}</span>

<span class="fc" id="L213">		List&lt;Value&gt; values = dataField.getValues();</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">		for(Value value : values){</span>
<span class="fc" id="L215">			Value.Property property = value.getProperty();</span>

<span class="pc bpc" id="L217" title="1 of 2 branches missed.">			switch(property){</span>
				case VALID:
<span class="fc" id="L219">					result.add(value.getValue());</span>
<span class="fc" id="L220">					break;</span>
				default:
					break;
			}
<span class="fc" id="L224">		}</span>

<span class="fc" id="L226">		return result;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>